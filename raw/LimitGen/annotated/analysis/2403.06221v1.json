{
    "title": "TRAD: Enhancing LLM Agents with Step-Wise Thought Retrieval and Aligned Decision",
    "abstract": "Numerous large language model (LLM) agents have been built for different tasks like web navigation and online shopping due to LLM’s wide knowledge and text-understanding ability. Among these works, many of them utilize in-context examples to achieve generalization without the need for fine-tuning, while few of them have considered the problem of how to select and effectively utilize these examples. Recently, methods based on trajectory-level retrieval with task meta-data and using trajectories as in-context examples have been proposed to improve the agent’s overall performance in some sequential decision making tasks. However, these methods can be problematic due to plausible examples retrieved without task-specific state transition dynamics and long input with plenty of irrelevant context. In this paper, we propose a novel framework (TRAD) to address these issues. TRAD first conducts Thought Retrieval, achieving step-level demonstration selection via thought matching, leading to more helpful demonstrations and less irrelevant input noise. Then, TRAD introduces Aligned Decision, complementing retrieved demonstration steps with their previous or subsequent steps, which enables tolerance for imperfect thought and provides a choice for balance between more context and less noise. Extensive experiments on ALFWorld and Mind2Web benchmarks show that TRAD not only outperforms state-of-the-art models but also effectively helps in reducing noise and promoting generalization. Furthermore, TRAD has been deployed in real-world scenarios of a global business insurance company and improves the success rate of robotic process automation. Our codes are available at: https://github.com/skyriver-2000/TRAD-Official.",
    "sections": [
        {
            "section_id": "1",
            "parent_section_id": null,
            "section_name": "1. Introduction",
            "text": "###figure_1### Large Language Models (LLMs) (Brown et al., 2020  ###reference_b4###; Touvron et al., 2023  ###reference_b33###) have achieved remarkable success on various tasks like question answering (Zheng et al., 2024a  ###reference_b46###), chatbot (Ouyang et al., 2022  ###reference_b21###), code synthesis (Roziere et al., 2023  ###reference_b25###), text ranking (Ferraretto et al., 2023  ###reference_b8###), table-based reasoning (Ye et al., 2023  ###reference_b44###), and retrieval query expansion (Mackie et al., 2023  ###reference_b18###) due to their wide knowledge and excellent ability of text understanding and generation. Recently, a series of works have attempted to build powerful agents based on LLMs for various sequential decision-making tasks, including text-based games (Yao et al., 2023a  ###reference_b42###), online shopping (Yao et al., 2022  ###reference_b41###), web navigation (Deng et al., 2023  ###reference_b5###), and information retrieval (Zhu et al., 2023  ###reference_b49###).\nAmong existing LLM agents, some are trained with large-scale expert data by supervised fine-tuning (SFT) (Nakano et al., 2021  ###reference_b19###; Gur et al., 2023  ###reference_b10###, 2024  ###reference_b9###), while some are tuning-free and utilize in-context learning (ICL) with few expert demonstration examples (Yao et al., 2023b  ###reference_b43###; Kim et al., 2023  ###reference_b14###; Wang et al., 2023d  ###reference_b35###; Zheng et al., 2024b  ###reference_b47###). In this paper, we focus the scope on tuning-free ICL methods, as they are highly cost-effective and can seamlessly generalize to different tasks using only a small amount of expert samples. Most existing ICL-based agents are prompted with expert trajectories carefully selected by human (Wei et al., 2022  ###reference_b39###; Yao et al., 2023b  ###reference_b43###; Shinn et al., 2023  ###reference_b29###), which work well when few expert trajectories are available. However, when we have access to a large dataset of expert trajectories or an expert policy, the automatic and personalized selection of expert trajectories for each task instruction becomes necessary, and can have an essential influence on task performance.\nRecently, Zheng et al. (2024b  ###reference_b47###) study the problem of demonstration selection and propose Synapse, which retrieves relevant expert trajectories by task meta-data, and then prompts LLMs with these retrieved trajectories. Synapse performs well on computer control tasks (MiniWob++ (Shi et al., 2017  ###reference_b28###)) and web navigation tasks (Mind2Web (Deng et al., 2023  ###reference_b5###)). Nevertheless, retrieving and prompting with complete trajectories can be problematic in the following three aspects.\nPlausible examples. Sometimes generalization to data from various domains can be critical. For example, in cross-website and cross-domain subsets of Mind2Web, agents operate on websites unseen in the training set, i.e., memory. In this case, retrieving trajectories with only task meta-data is very likely to provide plausible examples, which share similar task instructions to the current one but require totally different solutions. As shown by experiments in (Zheng et al., 2024b  ###reference_b47###), plausible examples provide no more information than random examples and can usually mislead LLM agents to wrong decisions.\nContext limit of LLMs. When facing tasks with long horizons and complex observations, prompting with complete trajectories will result in input sequences longer than the allowed length of LLMs. Synapse thus has to reduce the number of trajectory examples or even fail to complete the task directly. Though some long-context LLMs can receive very long prompts, the performance can be harmed due to the issue of long-term forgetting (Team, 2023  ###reference_b32###).\nIrrelevant information in prompts.\nLLMs are found sensitive to their prompts, and can easily copy their recent input (Radford et al., 2019  ###reference_b23###; Holtzman et al., 2020  ###reference_b12###). The decision at the current timestep can be related to very few steps in a retrieved trajectory, while other steps do not provide any helpful information. Therefore, irrelevant steps will have unpredictable effects on the decision of LLM agents. As shown by our experiments, they negatively impact the performance most of the time.\nTo address the problems of trajectory-wise retrieval and prompting, we delve into step-wise demonstration retrieval and prompting. We discover that, via demonstrating with relevant steps, the input context of the LLM agent can be significantly reduced. Thus, the issue of context limit and irrelevant information can be alleviated. Therefore, the critical part is to retrieve step demonstrations that are truly relevant and helpful. To achieve this, we utilize step-by-step reasoning, i.e. Chain-of-Thought technique (Wei et al., 2022  ###reference_b39###), to abstract the state at each timestep as retrieval queries and keys. The generated thoughts can involve historical information or future plans, which is more specific with state transitions and helpful in reducing plausible examples.\nIn this paper, we propose Thought Retrieval and Aligned Decision (TRAD), a novel framework that achieves step-wise demonstration retrieval via thought matching and enhances the context for action prediction with temporally neighboring steps and their order information. Our contribution can be summarized in four-folds:\nWe propose a thought retrieval method, where we label thoughts for expert demonstration steps in advance with an LLM, prompt LLM agents to reason at inference time, and achieve step-wise retrieval by a similarity search on thought. To the best of our knowledge, this is the first work that enables the LLM agent with thought retrieval techniques for sequential decision-making.\nBased on the thought retrieval operation, we further propose an aligned decision method, where we supply the retrieved steps with their temporal neighbors to overcome imperfect thoughts and enhance task-relevant information.\nWe conduct extensive experiments and analysis on Mind2Web (Deng et al., 2023  ###reference_b5###) tasks and ALFWorld (Shridhar et al., 2021  ###reference_b31###), showing that TRAD achieves state-of-the-art (SoTA) performance compared to existing works. TRAD brings a 2.99% improvement over the strongest baseline (93.78%  96.77%) to the success rate (SR) on ALFWorld. On Mind2Web, TRAD improves element accuracy, step SR, and SR remarkably over the powerful Synapse agent (Zheng et al., 2024b  ###reference_b47###) by 2.1%, 1.4%, and 0.5%.\nWe have deployed TRAD to the real-world robotic process automation scenarios of a global business insurance company, where TRAD enables the LLM agent to significantly improve the success rate in a bunch of practical tasks. In average, TRAD raises step SR from 90.2% to 98.1% and SR from 65.0% to 92.5%."
        },
        {
            "section_id": "2",
            "parent_section_id": null,
            "section_name": "2. Related Work",
            "text": ""
        },
        {
            "section_id": "2.1",
            "parent_section_id": "2",
            "section_name": "2.1. LLM Agents",
            "text": "In recent years, there has been a rapidly growing trend to utilize pre-trained LLMs as the central controller to obtain human-level decision-making capabilities (Wang et al., 2023b  ###reference_b36###). Among these works: Nakano et al. (2021  ###reference_b19###) fine-tune the GPT-3 (Brown et al., 2020  ###reference_b4###) model for question answering in a text-based web browsing environment. Yao et al. (2022  ###reference_b41###) develop WebShop, a simulated e-commerce website environment, and fine-tune a BERT (Devlin et al., 2018  ###reference_b6###) model with imitation learning and reinforcement learning. Yao et al. (2023b  ###reference_b43###) insert a reasoning section between observation input and action output, significantly improving the performance on ALFWorld (Shridhar et al., 2021  ###reference_b31###) and WebShop (Yao et al., 2022  ###reference_b41###) tasks. Shinn et al. (2023  ###reference_b29###) further improve over (Yao et al., 2023b  ###reference_b43###) via verbally reflecting on linguistic task feedback signals. Schick et al. (2023  ###reference_b27###) teach LLMs to use external tools via simple APIs in a self-supervised learning way. Park et al. (2023  ###reference_b22###) introduce Generative Agents, extending LLMs with natural language memories and retrieving them dynamically to plan behavior. Wang et al. (2023a  ###reference_b38###) propose DEPS, an interactive planning approach, which facilitates better error correction by integrating a description of the plan execution process and an explanation of failure feedback. Wang et al. (2023d  ###reference_b35###) employ an exploration curriculum, a growing skill library, and a novel iterative prompting mechanism, leading to better proficiency in playing Minecraft. Deng et al. (2023  ###reference_b5###) construct the Mind2Web dataset from real-world webpages, which consists of three subsets requiring different degrees of generalization, and compare the performance of imitation learning and few-shot inference.\nAs can be seen above, most existing LLM agents focus on: 1) improving task performance by direct fine-tuning (Nakano et al., 2021  ###reference_b19###; Yao et al., 2022  ###reference_b41###; Deng et al., 2023  ###reference_b5###); 2) enhancing planning or reasoning by explicitly prompting (Yao et al., 2023b  ###reference_b43###; Shinn et al., 2023  ###reference_b29###; Wang et al., 2023a  ###reference_b38###); 3) extending the application with an external memory or tool library (Schick et al., 2023  ###reference_b27###; Park et al., 2023  ###reference_b22###; Wang et al., 2023d  ###reference_b35###). However, providing more relevant information in prompts, as a fundamental way to elicit better task understanding, does not receive sufficient attention. When near-optimal demonstrations are accessible, selecting few-shot demonstrations properly can be a simple yet very effective way to improve task performance, which is investigated in our work."
        },
        {
            "section_id": "2.2",
            "parent_section_id": "2",
            "section_name": "2.2. In-Context Example Selection",
            "text": "LLMs have been shown excellence of few-shot learning (Brown et al., 2020  ###reference_b4###), and the selection of in-context examples can yield a significant improvement on the overall performance. Liu et al. (2021  ###reference_b17###) first propose to retrieve the -nearest neighbors (-NN) of the input as in-context examples, and achieve improvement over random retrieval baselines. Rubin et al. (2022  ###reference_b26###) select relevant samples with an encoder trained with label similarity, and obtain better performance over BM25 and pre-trained encoder baselines. Zhang et al. (2022  ###reference_b45###) consider selecting and labeling unlabeled examples as demonstrations to achieve the best performance, and view this problem as a sequential decision making task to solve by reinforcement learning. Wu et al. (2023  ###reference_b40###) further select examples in a subset recalled from -NN search via minimizing the entropy of output.\nIRCoT (Trivedi et al., 2023  ###reference_b34###) should be the most relevant work to ours, which retrieves relevant documents with reasoning steps on question-answering tasks. However, their method consists of retrieving with a complete historical trajectory and accumulating retrieved trajectories over time, which are not transferable to complex sequential decision-making tasks, and we propose a method different from theirs in that: (i) Our method focuses on both providing more relevant demonstrations and reducing irrelevant context for sequential decision-making tasks, while theirs is limited to question-answering tasks and only addresses the first issue.\n(ii) Our method retrieves completely different steps across timesteps and complements the retrieval results with temporal information, while theirs only accumulates relevant documents at every reasoning step and heuristically cuts off the earliest ones to fit in the context limit of LLMs.\n(iii) Our method prepares pseudo-golden thoughts for expert trajectories in the memory to enable retrieval with trajectories without thoughts, and utilizes single-step thoughts as both queries and keys for precise retrieval, while theirs uses thoughts only as queries with raw documents as keys.\n###figure_2### The selection of in-context examples has been studied thoroughly for non-sequential tasks like question answering and sentiment analysis. However, for sequential decision-making tasks, how to select the examples to improve the overall performance remains unclear. Zheng et al. (2024b  ###reference_b47###) propose a trajectory-wise retrieval solution, while a more precise step-wise solution is still desired as discussed in Section 1  ###reference_###, which motivates our work."
        },
        {
            "section_id": "2.3",
            "parent_section_id": "2",
            "section_name": "2.3. LLM Planning and Reasoning",
            "text": "Our work proposes to use thought, which can be viewed as a general abstraction of the current state, as queries and keys for retrieval. Nevertheless, plans, code comments, and any other text that extracts comprehensive information about the current state can serve as an alternative. Therefore, we particularly review some remarkable reasoning and planning works based on LLMs, and most of them are complementary to our work.\nWei et al. (2022  ###reference_b39###) first introduce the concept of Chain-of-Thought (CoT) by providing with explicit step-by-step reasoning process in example outputs improving performance on arithmetic, commonsense, and symbolic reasoning tasks. Wang et al. (2023c  ###reference_b37###) further find that a single reasoning path can be sub-optimal, and propose self-consistency to address this problem by sampling multiple reasoning paths.\nFor efficient yet flexible search of reasoning paths, Yao et al. (2023a  ###reference_b42###) apply tree search with self-evaluation to find globally excellent thoughts. Besta et al. (2023  ###reference_b3###) later extend the tree-search structure to a graph search for even better flexibility and overall performance.\nThe works mentioned above consider problems that are non-sequential or solvable by a single complete reasoning path after receiving the input. For harder sequential decision-making problems: Zhou et al. (2023  ###reference_b48###) introduce least-to-most prompting to solve hard problems by decomposing the problem and solving sub-problems sequentially. ReAct proposed by Yao et al. (2023b  ###reference_b43###) interacts with the environment in a reason-then-act style, which enriches the context for action prediction. Code-as-Policies (Liang et al., 2023  ###reference_b15###) writes executable codes for embodied control by hierarchically expanding undefined programs, which can be viewed as implicit reasoning or CoT process. Liu et al. (2023  ###reference_b16###) propose to incorporate the strength of classical planners by translating the original problem into a PDDL (Aeronautiques et al., 1998  ###reference_b2###) problem to solve by classical planners. Hao et al. (2023  ###reference_b11###) and Ding et al. (2023  ###reference_b7###) share a similar insight that reasoning can be implemented indeed by planning, where (Hao et al., 2023  ###reference_b11###) use LLMs as world models and (Ding et al., 2023  ###reference_b7###) conduct MCTS for thought generation with a light-weight extra network.\nTo summarize, LLM planning and reasoning have continuously received huge attention from researchers in recent years. This makes our work flexible and improvable with more powerful planning and reasoning methods in the future."
        },
        {
            "section_id": "3",
            "parent_section_id": null,
            "section_name": "3. The TRAD Framework",
            "text": "As discussed in Section 1  ###reference_###, trajectory-wise retrieving and prompting lead to issues of plausible examples, LLM context limits, and irrelevant information. To resolve these issues, we propose a novel method called Thought Retrieval and Aligned Decision (TRAD), as illustrated in Fig. 1  ###reference_###.\nOur TRAD agent utilizes thought, which is obtained by reasoning about its current state, to retrieve similar steps from expert trajectories, and is then complemented with steps temporally correlated to the retrieved ones and their temporal position information to predict the action. Formally, our TRAD agent can be summarized in one equation:\nwhere  is the current task,  and  are historical observations and actions,  is the thought generated by LLM about the current state, TR and AD denote our thought retrieval and aligned decision modules, and  refers to the thought-enhanced memory. We will present each module of TRAD in the following subsections."
        },
        {
            "section_id": "3.1",
            "parent_section_id": "3",
            "section_name": "3.1. Thought Preparation",
            "text": "Most expert trajectories, collected by either human or other expert agents, do not contain their reasoning process. Therefore, before we utilize thoughts for retrieval, we should prepare thoughts for each demonstration step in the memory. Specifically, we start from a small subset of expert demonstrations and provide thoughts written by human experts for each step in it. Given this small subset as few-shot examples in prompts, we can query LLMs to label thoughts for a large memory. Although ground-truth actions are not accessible at inference time, we can prompt LLMs with them to generate thoughts of higher quality. In this way, LLMs produce pseudo-golden thoughts consistent with expert actions, and we obtain a thought-enhanced memory  supporting both trajectory-wise retrieval with task meta-data and step-wise retrieval with thoughts."
        },
        {
            "section_id": "3.2",
            "parent_section_id": "3",
            "section_name": "3.2. Thought Retrieval",
            "text": "Given pseudo-golden thoughts for all steps in the memory, which can serve as keys for step-wise similarity search, we now present our thought retrieval method to select relevant demonstrations at inference time. To be specific, we first conduct trajectory-wise demonstration retrieval as in (Zheng et al., 2024b  ###reference_b47###) for thought generation. With these trajectory demonstrations, at each timestep  we prompt the LLM to generate a thought  for step-wise retrieval. Note that this process does not directly effects decision-making, hence it can be further simplified if necessary and the issues mentioned in Section 1  ###reference_### will not impact the agent severely.\nWith the thought , which can be viewed as an abstraction, about current state, we conduct dense retrieval to find relevant steps in the thought-enhance memory . Here any encoder pre-trained on a large corpus for retrieval, e.g., Sentence-BERT (Reimers and Gurevych, 2019  ###reference_b24###) and DPR (Karpukhin et al., 2020  ###reference_b13###), can be utilized to encode the query thought and key thoughts into dense vectors. Using a cosine similarity between the query and keys, we then collect top- relevant steps that belong to mutually different trajectories and their corresponding task instructions."
        },
        {
            "section_id": "3.3",
            "parent_section_id": "3",
            "section_name": "3.3. Aligned Decision",
            "text": "Now we have relevant demonstration steps from thought retrieval. However, the query thought can be imperfect due to the lack of expert action information at inference time. As we will show by ablation experiments in Section 4.4  ###reference_###, directly using these steps to form single-step demonstrations does not provide satisfactory performance, which is similar to the plausible example issue of trajectory-wise retrieval. Therefore, we propose an aligned decision method to incorporate more information during the decision-making process. Aligned decision complements LLM agents with steps temporally correlated to the retrieved ones and their temporal position information. As illustrated in Fig. 2  ###reference_###, the aligned decision method can be decomposed into following three sub-processes.\nTemporal expansion. For each retrieved step, we first expand it into a step sequence involving  previous steps and  subsequent steps. When the number of previous or subsequent steps is smaller than  or , we simply take all previous or subsequent steps. This transforms each retrieved step into at most  temporally successive steps, allowing LLM agents to correct their imperfect thoughts by looking at more related steps at decision-making time.\nRelative order mark. Given  expanded step sequences by temporal expansion, we insert a mark for each step (including the retrieved ones) indicating the relative position w.r.t. its corresponding retrieved step, and incorporate this rule of mark in the prompt for decision. For example, the last step before the retrieved one will be marked as [Step -1], the retrieved step as [Step 0], and the first step after the retrieved one as [Step 1]. This provides temporal information about the  demonstration steps, and promotes more accurate demonstration following.\nHistory alignment. Sometimes the optimal policy to a task, like ALFWorld, can be history-dependent, hence using single-step input for action prediction is unreasonable. Since we aim to reduce input content for less forgetting and noise, we should neither use all historical observations and actions. Moreover, even if we include previous actions as auxiliary information, there exists a mismatch where expert demonstrations are given as sequences of length  while current input is a single step. We thus propose to insert at most  previous input-output pairs (i.e. ) before current input , transforming current input into a similar sequence to demonstrations."
        },
        {
            "section_id": "4",
            "parent_section_id": null,
            "section_name": "4. Experiments",
            "text": "In this section, we aim to study the following research questions:\nHow does TRAD perform against existing SoTA methods?\nDoes thought retrieval help to reduce irrelevant context and improve the overall performance?\nDoes aligned decision help to supply information when generalization is important?\nDiving into aligned decision, are all temporal expansion (TE), relative order mark (ROM), and history alignment (HA) necessary for improvement?\nHow will the performance and advantage of TRAD be effected by critical hyper-parameters?"
        },
        {
            "section_id": "4.1",
            "parent_section_id": "4",
            "section_name": "4.1. Experiment Setup",
            "text": "To answer the above research questions, we conduct extensive experiments on ALFWorld (Shridhar et al., 2021  ###reference_b31###) and Mind2Web (Deng et al., 2023  ###reference_b5###) tasks. For each task, we introduce the details of evaluation as follows.\nALFWorld (Shridhar et al., 2021  ###reference_b31###) is a text-based game aligned with ALFRED (Shridhar et al., 2020  ###reference_b30###) benchmark. It involves 6 types of tasks where an agent must take a series of actions (e.g. go to shelf 1, take vase 2 from shelf 1, put vase 2 in/on cabinet 5) to achieve a high-level goal given by a natural language instruction (e.g. put some vase on a cabinet). This environment is challenging in three aspects: 1) Agent should determine likely places of a householding object and explore them one by one to find such object; 2) Agent should understand the usage of some objects like microwaves, fridges, and desklamps; 3) Some tasks can take an agent more than 30 steps to solve, requiring substantial long-term memorization.\nFollowing Shridhar et al. (2021  ###reference_b31###), we evaluate on the subset of 134 out-of-distribution tasks, comparing the task success rates of TRAD to ReAct (Yao et al., 2023b  ###reference_b43###) and Synapse (Zheng et al., 2024b  ###reference_b47###) (without state abstraction as observations are short). As ReAct and Synapse has provided sufficiently strong performances, we do not include more complex reasoning and planning baselines and corresponding variants of TRAD due to our API cost limit.\nNote that the original ReAct uses fixed but not retrieved trajectories as demonstrations, hence we test two ReAct baselines to eliminate such an effect:\nReAct (Fixed) uses fixed human-written trajectories as demonstrations;\nReAct (Random) randomly samples trajectories from the memory as demonstrations.\nFor fair comparison, TRAD uses thoughts in exactly the same format as ReAct, and shares a consistent memory of expert trajectories with Synapse. We also add a strong baseline (Synapse+ReAct) combining the trajectory-level retrieval in Synapse and the reasoning in ReAct. On ALFWorld, all methods are built with GPT-4 (OpenAI, 2023  ###reference_b20###) and 2 in-context examples.\nMind2Web (Deng et al., 2023  ###reference_b5###) is an HTML-based web navigation benchmark collected from real-world webpages, involving various tasks such as searching, trip booking, social network subscription, etc. It contains 3 subsets, i.e., cross-task, cross-website, cross-domain. This environment is challenging in two aspects: 1) Existing LLM agents can hardly understand HTML input well; 2) Unseen tasks and websites can require substantial generalization. Deng et al. (2023  ###reference_b5###) find that the cross-website and cross-domain subsets are significantly harder due to the need for generalization to unseen websites.\nSince Mind2Web was introduced only about half a year ago, there is a lack of suitable baseline algorithms, and thus we compare our TRAD agent to Synapse (Zheng et al., 2024b  ###reference_b47###) and ReAct (Yao et al., 2023b  ###reference_b43###). Following Zheng et al. (2024b  ###reference_b47###), we evaluate on all 3 subsets, comparing the element accuracy (Ele. Acc), step success rate (Step SR), and trajectory success rate (SR). For fair comparison, we follow (Zheng et al., 2024b  ###reference_b47###) and summarize observations into 5 web elements with the pre-trained element ranker provided by (Deng et al., 2023  ###reference_b5###) for all methods. Since the observations are still very complex on Mind2Web, including thoughts for every step in trajectories is not available, hence: 1) we do not include a Synapse + ReAct baseline; 2) TRAD generates thoughts and predicts actions by a single-step prompt with the current observation and previous actions (without previous observations). To eliminate the effect of prompting style and reasoning, we build two ReAct baselines using the same format of prompt as TRAD:\nReAct (Random), for which we prompt ReAct with completely random demonstration steps.\nReAct (Relevant), for which we prompt ReAct with demonstrate steps randomly chosen from trajectories retrieved by Synapse.\nWe do not include the ReAct (Fixed) baseline as it is hard to write or pick demonstrations commonly helpful for such diverse test sets.\nWe also provide the results of the simplest MindAct (Deng et al., 2023  ###reference_b5###) baseline without reasoning and retrieval for completeness. On Mind2Web, all methods are built with GPT-3.5-turbo and 3 in-context examples."
        },
        {
            "section_id": "4.2",
            "parent_section_id": "4",
            "section_name": "4.2. Evaluation on ALFWorld",
            "text": "The success rate of each method tested on ALFWorld is shown in Tab. 1  ###reference_###. Generally, our TRAD agent achieves an average success rate of 96.77%, significantly outperforming ReAct (90%), Synapse (89.55%), and even their strong combination (93.78%). It is also worth noting that the worst trial of TRAD among 3 random seeds achieves a success rate of 94.8%, outperforming the best trial produced by any other method (94.0%).\nDown to the success rate on each type of task, we observe that the success rate of each method varies more on the simplest Put task and the hardest PutTwo task. We discuss the results of these two tasks respectively as follows:\nOn the simplest Put task, ReAct performs even more poorly than other harder tasks. We find that the two vital reasons for ReAct’s failure on Put task are incorrect location and usage of objects, e.g. trying to put an object in a closed safe. As this issue can be alleviated through a combination with Synapse, the necessity of retrieving relevant demonstrations thus justified.\nTRAD achieves the largest improvement on the hardest PutTwo task. PutTwo requires to correct the locations of two objects and a comprehensive understanding of its task process. Since TRAD’s outstanding performance on this hardest task is obtained from a reduced input context at decision-making time, we can conclude that step-wise thought retrieval is helpful by reducing the noise of irrelevant steps and finding relevant examples more precisely."
        },
        {
            "section_id": "4.3",
            "parent_section_id": "4",
            "section_name": "4.3. Evaluation on Mind2Web",
            "text": "To verify the capability of TRAD under more realistic scenarios, we compare TRAD to ReAct and the current SoTA method, Synapse, on the Mind2Web benchmark, and the results are shown in Tab. 2  ###reference_###. We also include the results of Synapse without retrieval here to better illustrate the effect of different retrieval methods.\nGenerally, TRAD achieves the highest performance in terms of all 3 metrics averaged on 3 subsets. Considering that the trajectory-level retrieval of Synapse only brings marginal boosts on Cross-Task and Cross-Website subsets, and even slightly impacts the performance on the Cross-Domain subset, our TRAD method can be thus justified in two aspects:\nBy reducing input context and utilizing step-wise relevant demonstrations, our step-wise thought retrieval helps more than the trajectory-wise retrieval with task meta-data in Synapse to improve on the simplest Cross-Task subset.\nBy eliminating plausible examples and complementing temporal correlated steps, aligned decision helps to improve on the two harder subsets, especially the most out-of-distribution Cross-Domain subset.\nFurthermore, we observe that the two ReAct baselines perform poorly on this task, which indicates that:\nThe thoughts generated by GPT-3.5-turbo on Mind2Web tasks are not sufficient for LLM agents to infer the correct action.\nThe single-step prompting style which removes previous observations does not benefit overall performance.\nOn the contrary, TRAD utilizes these imperfect thoughts for retrieval rather than direct decision-making, and is complemented with temporally correlated steps via aligned decision. Therefore, TRAD is not negatively impacted by the imperfect thoughts, but transforms them into helpful information.\nBefore we start the study on detailed design and hyper-parameter choices of TRAD, we can summarize our performance evaluation on ALFWorld and Mind2Web benchmarks and answer the first three research questions as follows.\nAnswer to RQ1: On both householding (ALFWorld) and web navigation (Mind2Web) tasks, TRAD significantly outperforms curernt SoTA methods and becomes the new SoTA method.\nAnswer to RQ2: On ALFWorld benchmark, Synapse + ReAct generates thoughts in exactly the same way with our TRAD, and uses entire relevant trajectories (more information than TRAD) as demonstrations for action prediction. However, TRAD shows obvious advantage over this baseline. Therefore, we can conclude that TRAD benefits from more relevant demonstrations and less irrelevant input context brought by thought retrieval.\nAnswer to RQ3: On Mind2Web benchmark, TRAD achieves the most improvement over Synapse on the Cross-Domain subset which requires the most generalization. Therefore, we can tell that the aligned decision method complements critical information for decision-making on unseen input."
        },
        {
            "section_id": "4.4",
            "parent_section_id": "4",
            "section_name": "4.4. Ablation Studies",
            "text": "We have verified the effectiveness of TRAD on two different scenarios, i.e., automatic householding and web navigation. Next, we are to examine the effect of each module in TRAD. Due to our limited budget for API usage, all ablation studies are conducted on the Mind2Web benchmark with GPT-3.5-turbo."
        },
        {
            "section_id": "4.4.1",
            "parent_section_id": "4.4",
            "section_name": "4.4.1. The Effect of Aligned Decision",
            "text": "First, we study the effect of macro building blocks of TRAD. Since eliminating thought retrieval will disable aligned decision at the same time and break the framework fundamentally, we do not remove the thought retrieval module, but ablate each component of aligned decision, i.e., temporal expansion (TE), relative order mark (ROM), and history alignment (HA), and compare the corresponding performances. The results are shown in Tab. 3  ###reference_###.\nFrom Tab. 3  ###reference_###, we observe that the performance without each component varies differently on the simplest Cross-Task subset and the two harder subsets:\nOn the harder Cross-Website and Cross-Domain subsets, the elimination of all three modules in aligned decision results in a significant performance drop, and the effect of temporal expansion is the most significant. This is intuitive, since only retrieved steps are provided to the agent without TE, and thus the agent becomes more vulnerable to imperfect thoughts.\nOn the simplest Cross-Task subset, however, history alignment and relative order mark are not that helpful and even cause performance drop. As discussed earlier (Section 1  ###reference_### and Section 3.3  ###reference_###), when the issue of plausible examples is not severe, reducing context and prompting with the most relevant demonstration becomes the dominant factor of performance boost. Therefore, only temporal expansion remains beneficial for recovering from imperfect thoughts, while the other two components lead to sub-optimal performance.\nGenerally, the aligned decision method provides more information about the source trajectories of retrieved steps and the current trajectory, and helps especially for scenarios where generalization is essential. We can now summarize these observations and answer the fourth research question.\nAnswer to RQ4: Among the sub-processes in aligned decision, 1) temporal expansion provides tolerance for imperfect thoughts and improves the overall performance of TRAD consistently; 2) relative order mark and history alignment complement TRAD with temporal information about the trajectories of retrieved steps and the current trajectory, which serve as useful context for out-of-distribution decision-making but may become less useful for in-distribution decision-making."
        },
        {
            "section_id": "4.4.2",
            "parent_section_id": "4.4",
            "section_name": "4.4.2. The Effect of Expansion Steps  and",
            "text": "Next we vary a critical hyper-parameter, the number of temporal expansion steps, and investigate how the overall performance will change accordingly. To avoid an expensive grid search on  and , we consider only one-side expansion by varying  or  from  to  with the other set to . The results over all 3 subsets are shown in Fig. 3  ###reference_###.\n###figure_3### ###figure_4### From Fig. 3  ###reference_###, we can have the following observations:\nBoth forward expansion () and backward expansion () achieve improvement compared to no expansion (). This justifies our design of aligned decision.\nEither forward expansion or backward expansion does not benefit from increasing a large enough  or  further. This proves our hypothesis that irrelevant context too far from the current state is of little value and even noisy.\nGenerally, forward expansion performs better than backward expansion when varying  and . The reason for this phenomenon might be that historical information has been incorporated in thoughts and thus future information helps more.\nTRAD achieves its best performance when  and , and consistently outperforms Synapse with forward expansion."
        },
        {
            "section_id": "4.4.3",
            "parent_section_id": "4.4",
            "section_name": "4.4.3. The Effect of Demonstration Amount",
            "text": "Finally, we look into a common yet important hyper-parameter, the number of retrieved demonstrations , and see how the advantage of TRAD over the baseline (Synapse) will change given different . We show the results over all 3 subsets in Fig. 4  ###reference_###. Note that the trajectory-wise prompting in Synapse frequently exceeds the context limit when , and thus we omit this result.\n###figure_5### From Fig. 4  ###reference_###, we see that  has a mild effect on the performance of TRAD and Synapse, and that the advantage of TRAD over Synapse consistently remains for all .\nWith results in Section 4.4.2  ###reference_.SSS2### and Section 4.4.3  ###reference_.SSS3###, we now respond to our last research question.\nAnswer to RQ5: The performance and advantage of TRAD generally remains stable with different hyper-parameter choices, i.e., temporal expansion steps, number of retrieved demonstrations. Its performance and advantage only degrade when using long backward extension, which is possibly due to the fact that historical information has already been incorporated in thoughts and does not provide further help for decision-making."
        },
        {
            "section_id": "5",
            "parent_section_id": null,
            "section_name": "5. Real-World Deployment of TRAD",
            "text": "Since Dec. 2023, we have deployed our TRAD agent to automate some real-world office tasks in a mainstream insurance company, which owns a global business with approximately 170 million customers worldwide. We select 4 different websites and collect 100 expert trajectories for some representative tasks on each website as our memory. For evaluation, we collect 20 unseen tasks on each website, using step success rate (Step SR) and trajectory success rate (SR) as evaluation metrics. Tasks involve filling in insurance inquiry forms, implementing advanced information retrieval, etc. Since the websites are complex and contain thousands of web elements, prompting with complete trajectories is not available, hence we only consider single-step prompting with historical actions as auxiliary information.\nTo verify the effectiveness of TRAD, we use two different ReAct agents that the company has attempted as our baseline:\nReAct-RD: randomly selects expert steps in random trajectories as demonstrations.\nReAct-RV: randomly selects expert steps in relevant trajectories retrieved by task instruction as demonstrations.\nTo be specific, the difference between TRAD and ReAct-RV is using thought for a second-time step retrieval and the aligned decision module. To further investigate the effect of thought retrieval and aligned decision, we also deploy a TR agent which removes our aligned decision method, namely the TRAD w/o TE baseline in Tab. 3  ###reference_###. We list the results in Tab. 4  ###reference_###.\nAs can be seen in Tab. 4  ###reference_###, TRAD achieves the best performance on all 4 websites, showing its advantage can remain when deployed to real-world scenarios. Moreover, we observe that TRAD w/o TE baseline also outperforms both ReAct agents, but exhibits noticeable disadvantages compared to the complete TRAD agents. This justifies our design of both thought retrieval and aligned decision.\nInference efficiency of TRAD. At inference time, our TRAD agent only introduces little extra time consumption in thought retrieval compared to ReAct. We profile the inference process of TRAD and ReAct on all websites and tasks, and in average TRAD takes only 11.7% more time than ReAct-RD, which indicates that our method achieves improvement without much sacrifice on efficiency."
        },
        {
            "section_id": "6",
            "parent_section_id": null,
            "section_name": "6. Discussions",
            "text": ""
        },
        {
            "section_id": "6.1",
            "parent_section_id": "6",
            "section_name": "6.1. Limitations of TRAD",
            "text": "Although TRAD exhibits excellent performances over a diverse set of tasks, it still has limitations like dependence on high-quality thought and trade-off between information and noise in temporal expansion, and we briefly discuss about them here."
        },
        {
            "section_id": "6.1.1",
            "parent_section_id": "6.1",
            "section_name": "6.1.1. Dependence on high-quality thought.",
            "text": "TRAD alleviates the issue of imperfect thoughts by its aligned decision module, but its capability still depends heavily on the quality of thoughts and the capability of backbone LLM. To make such a step-wise retrieval-augmented method work well, the abstraction of current state is critical since it serves as the query and key for retrieval, hence the LLM used to build a TRAD agent should at least have a decent understanding of the task."
        },
        {
            "section_id": "6.1.2",
            "parent_section_id": "6.1",
            "section_name": "6.1.2. Trade-off in temporal expansion.",
            "text": "TRAD expects to keep relevant information but reduce irrelevant input context by step-wise thought retrieval, while preserving some chance for correcting imperfect thoughts by temporal expansion. Here exists a trade-off: a longer temporal expansion brings not only more tolerance to imperfect thoughts, but also more irrelevant noise in demonstrations. This trade-off requires careful consideration for different tasks."
        },
        {
            "section_id": "6.2",
            "parent_section_id": "6",
            "section_name": "6.2. Future Directions",
            "text": "While ablation studies have been conducted to justify our design of TRAD, there are some promising ideas worth study which can probably improve TRAD further. We leave them as future works, and discuss them as follows."
        },
        {
            "section_id": "6.2.1",
            "parent_section_id": "6.2",
            "section_name": "6.2.1. Better Demonstrations For Reasoning",
            "text": "TRAD currently employs relevant trajectories or randomly-chosen steps from them as demonstrations to generate thoughts, which still suffers from the issues discussed in Section 1  ###reference_### to some extent. Therefore, modifications can be made to generate thoughts of higher quality, and thus improve the overall performance of TRAD."
        },
        {
            "section_id": "6.2.2",
            "parent_section_id": "6.2",
            "section_name": "6.2.2. Better Representations For Retrieval",
            "text": "As we have discussed in Section 2.3  ###reference_###, TRAD can utilize any other methods to obtain a comprehensive abstraction of the current state in a sequential decision-making task, which can possibly serve as better queries and keys for the step-wise demonstration retrieval. Therefore,\nTRAD can be combined with more powerful LLM planning and reasoning methods and even dense abstractions produced by LLMs pre-trained on domain-specific data like (Gur et al., 2024  ###reference_b9###)."
        },
        {
            "section_id": "7",
            "parent_section_id": null,
            "section_name": "7. Conclusions",
            "text": "In this work, we propose a novel LLM agent augmented by step-wise demonstration retrieval (TRAD) for sequential decision-making tasks. TRAD first retrieves relevant step demonstrations by its thought about current state, and then complements temporally correlated steps for more informative action prediction. Extensive experiments are conducted on two different sequential decision-making tasks to validate the effectiveness of our solution, and thorough ablation studies justify the design choice and stability of our method. We further present the results from real-world deployment of our method, showing its value in real-world applications."
        }
    ]
}